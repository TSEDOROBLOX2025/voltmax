<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOLTMAX - Gestão Corporativa</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #007BFF;
            --primary-dark: #0056b3;
            --secondary: #6c757d;
            --bg-light: #f4f6f9;
            --white: #ffffff;
            --text-dark: #333;
            --text-muted: #777;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --radius: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body { background-color: var(--bg-light); color: var(--text-dark); height: 100vh; overflow: hidden; }

        /* --- UTILITÁRIOS --- */
        .hidden { display: none !important; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .w-100 { width: 100%; }
        .mb-3 { margin-bottom: 1rem; }
        .mt-3 { margin-top: 1rem; }

        /* --- LOGIN / REGISTER --- */
        #auth-screen {
            display: flex; justify-content: center; align-items: center; height: 100vh;
            background: linear-gradient(135deg, var(--primary), #00d2ff);
        }
        .auth-box {
            background: white; padding: 2rem; border-radius: var(--radius);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px; text-align: center;
        }
        .auth-logo { color: var(--primary); font-size: 2.5rem; margin-bottom: 1rem; font-weight: 800; }
        .auth-input {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd;
            border-radius: 4px; outline: none; transition: 0.3s;
        }
        .auth-input:focus { border-color: var(--primary); }

        /* --- DASHBOARD LAYOUT --- */
        #app-screen { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar {
            width: 250px; background: #343a40; color: white; display: flex; flex-direction: column;
            transition: 0.3s; flex-shrink: 0;
        }
        .sidebar-header { padding: 20px; text-align: center; background: #212529; }
        .sidebar-header i { color: var(--primary); }
        .nav-links { list-style: none; padding: 20px 0; flex-grow: 1; }
        .nav-item {
            padding: 15px 25px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .nav-item:hover, .nav-item.active { background: var(--primary); }
        .user-info-bar { padding: 15px; background: #2c3035; font-size: 0.9rem; border-top: 1px solid #444; }

        /* Main Content */
        .main-content { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .topbar {
            background: white; padding: 15px 30px; display: flex; justify-content: space-between;
            align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .page-content { padding: 30px; }
        .page-title { margin-bottom: 25px; color: var(--secondary); border-bottom: 2px solid #ddd; padding-bottom: 10px; }

        /* --- CARDS & WIDGETS --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); position: relative; }
        .card h3 { font-size: 1rem; color: var(--text-muted); margin-bottom: 10px; }
        .card .value { font-size: 2rem; font-weight: bold; color: var(--text-dark); }
        .card-icon { position: absolute; top: 20px; right: 20px; font-size: 2.5rem; opacity: 0.1; }

        /* --- TABLES --- */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--primary); color: white; }
        tr:hover { background-color: #f8f9fa; }
        
        /* --- BADGES --- */
        .badge { padding: 5px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        .bg-pending { background: #ffeeba; color: #856404; }
        .bg-done { background: #d4edda; color: #155724; }
        .bg-admin { background: #cce5ff; color: #004085; }
        .bg-func { background: #e2e3e5; color: #383d41; }

        /* --- FORMS & MODALS --- */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content { background: white; padding: 25px; border-radius: var(--radius); width: 90%; max-width: 500px; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; }

        /* --- TOAST --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        .toast {
            background: #333; color: white; padding: 15px 25px; margin-top: 10px; border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px;
        }
        .toast.success { border-left: 5px solid var(--success); }
        .toast.error { border-left: 5px solid var(--danger); }
        
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #app-screen { flex-direction: column; }
            .sidebar { width: 100%; height: auto; display: none; }
            .sidebar.active { display: flex; }
            .mobile-menu-btn { display: block; }
        }
        @media (min-width: 769px) { .mobile-menu-btn { display: none; } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="auth-screen">
        <div class="auth-box">
            <div class="auth-logo"><i class="fas fa-bolt"></i> VOLTMAX</div>
            <h3 id="auth-title">Login Corporativo</h3>
            <p class="mb-3 text-muted">Entre com suas credenciais</p>
            
            <form id="login-form">
                <input type="text" id="login-nick" class="auth-input" placeholder="Nick do Roblox" required>
                <input type="password" id="login-pass" class="auth-input" placeholder="Senha" required>
                <button type="submit" class="btn btn-primary w-100">ENTRAR</button>
            </form>

            <form id="register-form" class="hidden">
                <input type="text" id="reg-name" class="auth-input" placeholder="Nome Completo" required>
                <input type="text" id="reg-nick" class="auth-input" placeholder="Nick do Roblox" required>
                <input type="password" id="reg-pass" class="auth-input" placeholder="Senha" required>
                <button type="submit" class="btn btn-success w-100">CRIAR CONTA</button>
            </form>

            <div class="mt-3">
                <a href="#" id="toggle-auth" style="color: var(--primary); text-decoration: none;">Criar uma conta</a>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-bolt"></i> VOLTMAX</h2>
            </div>
            <ul class="nav-links">
                <li class="nav-item active" onclick="router('home')">
                    <i class="fas fa-home"></i> Dashboard
                </li>
                <li class="nav-item" onclick="router('os')">
                    <i class="fas fa-tools"></i> Ordens de Serviço
                </li>
                <li class="nav-item" onclick="router('notices')">
                    <i class="fas fa-bullhorn"></i> Avisos
                </li>
                <li class="nav-item role-func role-admin hidden" onclick="router('ponto')">
                    <i class="fas fa-clock"></i> Registrar Ponto
                </li>
                <li class="nav-item role-admin hidden" onclick="router('users')">
                    <i class="fas fa-users-cog"></i> Usuários
                </li>
            </ul>
            <div class="user-info-bar">
                <div id="sidebar-user-name">Usuário</div>
                <div id="sidebar-user-role" style="color: #aaa; font-size: 0.8em;">Cargo</div>
                <button onclick="logout()" class="btn btn-danger w-100 mt-3" style="font-size: 0.8em;">SAIR</button>
            </div>
        </div>

        <div class="main-content">
            <div class="topbar">
                <button class="btn btn-secondary mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                <h3 id="topbar-title">Dashboard</h3>
                <div>
                    <span class="badge bg-primary" id="topbar-date"></span>
                </div>
            </div>

            <div class="page-content">
                <div id="view-home" class="view-section">
                    <h2 class="page-title">Visão Geral</h2>
                    <div class="dashboard-grid">
                        <div class="card">
                            <h3>Avisos Recentes</h3>
                            <div class="value" id="stats-notices">0</div>
                            <i class="fas fa-bullhorn card-icon"></i>
                        </div>
                        <div class="card">
                            <h3>O.S. Pendentes</h3>
                            <div class="value" id="stats-os-pending">0</div>
                            <i class="fas fa-tools card-icon"></i>
                        </div>
                        <div class="card">
                            <h3>Meu Cargo</h3>
                            <div class="value" style="font-size: 1.2rem;" id="stats-role">...</div>
                            <i class="fas fa-id-badge card-icon"></i>
                        </div>
                    </div>

                    <div class="card" style="height: 400px;">
                        <h3>Consumo da Rede (Simulado em Tempo Real)</h3>
                        <canvas id="energyChart"></canvas>
                    </div>
                </div>

                <div id="view-os" class="view-section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 class="page-title">Ordens de Serviço</h2>
                        <button class="btn btn-primary" onclick="openModal('modal-os')"><i class="fas fa-plus"></i> Nova O.S.</button>
                    </div>
                    
                    <div class="table-responsive">
                        <table id="table-os">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Bairro</th>
                                    <th>Endereço</th>
                                    <th>Status</th>
                                    <th>Solicitante</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="view-notices" class="view-section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 class="page-title">Quadro de Avisos</h2>
                        <button class="btn btn-primary role-admin hidden" onclick="openModal('modal-notice')"><i class="fas fa-plus"></i> Criar Aviso</button>
                    </div>
                    <div id="notices-container" style="display: grid; gap: 15px;">
                        </div>
                </div>

                <div id="view-ponto" class="view-section hidden">
                    <h2 class="page-title">Registro de Ponto</h2>
                    <div class="card" style="text-align: center; max-width: 400px; margin: 0 auto;">
                        <h3 class="mb-3">Horário Atual</h3>
                        <div id="clock-display" style="font-size: 3rem; font-weight: bold; color: var(--primary); margin: 20px 0;">00:00:00</div>
                        <button class="btn btn-success w-100" onclick="registrarPonto()"><i class="fas fa-check-circle"></i> REGISTRAR PONTO AGORA</button>
                    </div>

                    <h3 class="mt-3">Meu Histórico</h3>
                    <div class="table-responsive mt-3">
                        <table id="table-ponto">
                            <thead><tr><th>Data/Hora</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-users" class="view-section hidden">
                    <h2 class="page-title">Gestão de Usuários</h2>
                    <div class="table-responsive">
                        <table id="table-users">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Nick</th>
                                    <th>Cargo Atual</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="modal-os" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Abrir Ordem de Serviço</h3>
                <button class="close-modal" onclick="closeModal('modal-os')">&times;</button>
            </div>
            <form id="form-os">
                <div class="form-group">
                    <label>Tipo de Ocorrência</label>
                    <select id="os-type" class="form-control" required>
                        <option value="Queda de Energia">Queda de Energia</option>
                        <option value="Poste Danificado">Poste Danificado</option>
                        <option value="Troca de Titularidade">Troca de Titularidade</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Bairro</label>
                    <select id="os-bairro" class="form-control" required>
                        <option>Bairro Green Ville</option>
                        <option>Bairro Vista Azul</option>
                        <option>Bairro Urbano</option>
                        <option>Bairro da Justiça</option>
                        <option>Bairro Jatiúca</option>
                        <option>Bairro Pajuçara</option>
                        <option>Bairro Solar Ville</option>
                        <option>Bairro Maré Alta</option>
                        <option>Bairro Nova Esperança</option>
                        <option>Bairro Horizonte</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Endereço Completo</label>
                    <input type="text" id="os-address" class="form-control" placeholder="Rua, Número, Referência" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Abrir Solicitação</button>
            </form>
        </div>
    </div>

    <div id="modal-notice" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Publicar Aviso Oficial</h3>
                <button class="close-modal" onclick="closeModal('modal-notice')">&times;</button>
            </div>
            <form id="form-notice">
                <div class="form-group">
                    <label>Título</label>
                    <input type="text" id="notice-title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Descrição</label>
                    <textarea id="notice-desc" class="form-control" rows="4" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">Publicar</button>
            </form>
        </div>
    </div>

    <script type="module">
        // Importar Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update, get, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = {
            databaseURL: "https://voltmax-empresa-default-rtdb.firebaseio.com/"
        };

        // INICIALIZAR APP
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ESTADO GLOBAL
        let currentUser = null; // { uid, name, nick, role }
        
        // --- AUTH SYSTEM ---
        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const toggleAuthBtn = document.getElementById('toggle-auth');
        const authTitle = document.getElementById('auth-title');

        // Alternar Login/Registro
        toggleAuthBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if(loginForm.classList.contains('hidden')){
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                authTitle.innerText = "Login Corporativo";
                toggleAuthBtn.innerText = "Criar uma conta";
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                authTitle.innerText = "Registro de Cidadão";
                toggleAuthBtn.innerText = "Já tenho conta";
            }
        });

        // Registrar
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const nick = document.getElementById('reg-nick').value;
            const pass = document.getElementById('reg-pass').value;

            // ID único baseado no nick (sanitizado)
            const uid = nick.toLowerCase().replace(/[^a-z0-9]/g, '');

            // Verificar se usuário existe
            const snapshot = await get(child(ref(db), `users/${uid}`));
            if (snapshot.exists()) {
                showToast('Este Nick já está cadastrado.', 'error');
                return;
            }

            // Regra da Senha Mestre para Admin
            let role = 'CIDADÃO';
            if (pass === 'acessluk') role = 'ADMIN';

            const userData = {
                name: name,
                robloxNick: nick,
                password: pass, // Nota: Em produção real, nunca salve senhas em texto puro!
                role: role
            };

            await set(ref(db, 'users/' + uid), userData);
            showToast('Conta criada com sucesso! Faça login.', 'success');
            toggleAuthBtn.click(); // Volta para login
        });

        // Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nick = document.getElementById('login-nick').value;
            const pass = document.getElementById('login-pass').value;
            const uid = nick.toLowerCase().replace(/[^a-z0-9]/g, '');

            const snapshot = await get(child(ref(db), `users/${uid}`));
            
            if (snapshot.exists()) {
                const data = snapshot.val();
                if (data.password === pass) {
                    // Login Sucesso
                    currentUser = { ...data, uid: uid };
                    
                    // Se a senha for a mestre, garante admin (caso tenha sido alterado manualmente)
                    if(pass === 'acessluk' && data.role !== 'ADMIN') {
                         update(ref(db, 'users/' + uid), { role: 'ADMIN' });
                         currentUser.role = 'ADMIN';
                    }

                    enterDashboard();
                } else {
                    showToast('Senha incorreta.', 'error');
                }
            } else {
                showToast('Usuário não encontrado.', 'error');
            }
        });

        window.logout = function() {
            currentUser = null;
            appScreen.classList.add('hidden');
            authScreen.classList.remove('hidden');
            // Reset forms
            loginForm.reset();
        }

        function enterDashboard() {
            authScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            
            // Preencher Sidebar
            document.getElementById('sidebar-user-name').innerText = currentUser.name;
            document.getElementById('sidebar-user-role').innerText = currentUser.role.toUpperCase();
            document.getElementById('stats-role').innerText = currentUser.role.toUpperCase();
            
            // Controle de Permissões (Visibilidade)
            const adminElements = document.querySelectorAll('.role-admin');
            const funcElements = document.querySelectorAll('.role-func');

            adminElements.forEach(el => el.classList.add('hidden'));
            funcElements.forEach(el => el.classList.add('hidden'));

            if (currentUser.role === 'ADMIN') {
                adminElements.forEach(el => el.classList.remove('hidden'));
                funcElements.forEach(el => el.classList.remove('hidden'));
            } else if (currentUser.role === 'FUNCIONÁRIO') {
                funcElements.forEach(el => el.classList.remove('hidden'));
            }

            // Iniciar Listeners de Dados
            initDataListeners();
            initChart();
            router('home'); // Vai para home
            startClock();
        }

        // --- NAVIGATION ROUTER ---
        window.router = function(viewName) {
            // Esconder todas as views
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            // Remover active da sidebar
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // Mostrar view desejada
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // Título Topbar
            const titles = {
                'home': 'Dashboard Geral',
                'os': 'Gerenciamento de O.S.',
                'notices': 'Avisos Corporativos',
                'ponto': 'Meu Ponto Eletrônico',
                'users': 'Controle de Acessos'
            };
            document.getElementById('topbar-title').innerText = titles[viewName];
        }

        // --- DASHBOARD LOGIC ---

        function initDataListeners() {
            // 1. AVISOS
            const noticesRef = ref(db, 'notices');
            onValue(noticesRef, (snapshot) => {
                const container = document.getElementById('notices-container');
                container.innerHTML = '';
                let count = 0;
                
                snapshot.forEach((childSnapshot) => {
                    const notice = childSnapshot.val();
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.borderLeft = '5px solid var(--primary)';
                    card.innerHTML = `
                        <h3>${notice.title} <span style="float:right; font-size:0.8em; font-weight:normal">${notice.date}</span></h3>
                        <p>${notice.desc}</p>
                        <small style="color:#888; display:block; margin-top:10px;">Por: ${notice.author}</small>
                    `;
                    container.prepend(card); // Mais recente no topo
                    count++;
                });
                document.getElementById('stats-notices').innerText = count;
            });

            // 2. ORDENS DE SERVIÇO
            const osRef = ref(db, 'os');
            onValue(osRef, (snapshot) => {
                const tbody = document.querySelector('#table-os tbody');
                tbody.innerHTML = '';
                let pendingCount = 0;

                snapshot.forEach((childSnapshot) => {
                    const os = childSnapshot.val();
                    const key = childSnapshot.key;

                    // Filtros de visualização
                    // Cidadão vê apenas as suas? O requisito diz "Pode visualizar e abrir". 
                    // Geralmente Cidadão vê as suas, Func/Admin vê todas.
                    // Vamos deixar Func/Admin ver todas, Cidadão ver as próprias.
                    
                    let canView = false;
                    if(currentUser.role === 'ADMIN' || currentUser.role === 'FUNCIONÁRIO') canView = true;
                    if(currentUser.role === 'CIDADÃO' && os.userUid === currentUser.uid) canView = true;

                    if (canView) {
                        if(os.status === 'PENDENTE') pendingCount++;
                        
                        const tr = document.createElement('tr');
                        
                        // Botão de ação (Apenas Admin/Func pode concluir)
                        let actionBtn = '';
                        if((currentUser.role === 'ADMIN' || currentUser.role === 'FUNCIONÁRIO') && os.status === 'PENDENTE') {
                            actionBtn = `<button class="btn btn-success" style="padding:5px 10px; font-size:0.8rem" onclick="completeOS('${key}')">Concluir</button>`;
                        }

                        const statusBadge = os.status === 'PENDENTE' 
                            ? '<span class="badge bg-pending">PENDENTE</span>' 
                            : '<span class="badge bg-done">CONCLUIDO</span>';

                        tr.innerHTML = `
                            <td>${os.type}</td>
                            <td>${os.bairro}</td>
                            <td>${os.address}</td>
                            <td>${statusBadge}</td>
                            <td>${os.userName}</td>
                            <td>${actionBtn}</td>
                        `;
                        tbody.prepend(tr);
                    }
                });
                document.getElementById('stats-os-pending').innerText = pendingCount;
            });

            // 3. USUÁRIOS (Admin)
            if(currentUser.role === 'ADMIN') {
                const usersRef = ref(db, 'users');
                onValue(usersRef, (snapshot) => {
                    const tbody = document.querySelector('#table-users tbody');
                    tbody.innerHTML = '';
                    
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        const uid = childSnapshot.key;
                        
                        const tr = document.createElement('tr');
                        const isSelf = uid === currentUser.uid;
                        
                        let roleSelect = '';
                        if(!isSelf) {
                            roleSelect = `
                                <select onchange="changeUserRole('${uid}', this.value)" style="padding:5px;">
                                    <option value="CIDADÃO" ${user.role === 'CIDADÃO' ? 'selected' : ''}>Cidadão</option>
                                    <option value="FUNCIONÁRIO" ${user.role === 'FUNCIONÁRIO' ? 'selected' : ''}>Funcionário</option>
                                    <option value="ADMIN" ${user.role === 'ADMIN' ? 'selected' : ''}>Admin</option>
                                </select>
                            `;
                        } else {
                            roleSelect = `<b>${user.role}</b>`;
                        }

                        tr.innerHTML = `
                            <td>${user.name}</td>
                            <td>${user.robloxNick}</td>
                            <td>${roleSelect}</td>
                            <td>${isSelf ? '-' : '<i class="fas fa-user-edit"></i>'}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
            }

            // 4. PONTO (Se for func/admin)
            if(currentUser.role !== 'CIDADÃO') {
                const hoursRef = ref(db, `hours/${currentUser.uid}`);
                onValue(hoursRef, (snapshot) => {
                    const tbody = document.querySelector('#table-ponto tbody');
                    tbody.innerHTML = '';
                    snapshot.forEach((child) => {
                        const timeData = child.val();
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${timeData.time}</td>`;
                        tbody.prepend(tr);
                    });
                });
            }
        }

        // --- ACTIONS ---

        // Abrir OS
        const formOS = document.getElementById('form-os');
        formOS.addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.getElementById('os-type').value;
            const bairro = document.getElementById('os-bairro').value;
            const address = document.getElementById('os-address').value;

            const newOS = {
                type,
                bairro,
                address,
                status: 'PENDENTE',
                userUid: currentUser.uid,
                userName: currentUser.name + ' (' + currentUser.robloxNick + ')',
                createdAt: new Date().toLocaleString()
            };

            await push(ref(db, 'os'), newOS);
            showToast('Ordem de Serviço aberta!', 'success');
            closeModal('modal-os');
            formOS.reset();
        });

        // Concluir OS
        window.completeOS = async function(key) {
            if(confirm('Marcar esta O.S. como concluída?')) {
                await update(ref(db, `os/${key}`), { status: 'CONCLUIDO' });
                showToast('O.S. Concluída', 'success');
            }
        }

        // Criar Aviso
        const formNotice = document.getElementById('form-notice');
        formNotice.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('notice-title').value;
            const desc = document.getElementById('notice-desc').value;

            const newNotice = {
                title,
                desc,
                date: new Date().toLocaleDateString(),
                author: currentUser.name
            };

            await push(ref(db, 'notices'), newNotice);
            showToast('Aviso publicado!', 'success');
            closeModal('modal-notice');
            formNotice.reset();
        });

        // Mudar Cargo
        window.changeUserRole = async function(uid, newRole) {
            await update(ref(db, `users/${uid}`), { role: newRole });
            showToast(`Cargo alterado para ${newRole}`, 'success');
        }

        // Registrar Ponto
        window.registrarPonto = async function() {
            const now = new Date().toLocaleString();
            await push(ref(db, `hours/${currentUser.uid}`), { time: now });
            showToast('Ponto registrado às ' + now, 'success');
        }

        // --- UI HELPERS ---
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');

        function showToast(msg, type) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle"></i> ${msg}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Relógio
        function startClock() {
            const display = document.getElementById('clock-display');
            const dateDisplay = document.getElementById('topbar-date');
            setInterval(() => {
                const now = new Date();
                display.innerText = now.toLocaleTimeString();
                dateDisplay.innerText = now.toLocaleDateString();
            }, 1000);
        }

        // Gráfico (Chart.js)
        function initChart() {
            const ctx = document.getElementById('energyChart').getContext('2d');
            
            // Dados simulados
            let dataPoints = [120, 135, 125, 145, 160, 150, 170, 180, 165, 155];
            
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'],
                    datasets: [{
                        label: 'Consumo (kWh)',
                        data: dataPoints,
                        borderColor: '#007BFF',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 } // Desabilitar animação pesada para simulação
                }
            });

            // Simular atualização realtime
            setInterval(() => {
                const lastVal = dataPoints[dataPoints.length - 1];
                const newVal = Math.max(100, lastVal + (Math.random() - 0.5) * 20);
                dataPoints.shift();
                dataPoints.push(newVal);
                chart.update();
            }, 2000);
        }

    </script>
</body>
</html>
