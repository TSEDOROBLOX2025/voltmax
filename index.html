<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOLTMAX | Hub Corporativo de Energia</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --white: #FFFFFF;
            --blue-main: #66B2FF;
            --blue-dark: #4A90E2;
            --gray-bg: #F4F7F9;
            --text-dark: #2C3E50;
            --text-light: #7F8C8D;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--gray-bg); color: var(--text-dark); line-height: 1.6; }
        h1, h2, h3 { font-family: 'Montserrat', sans-serif; font-weight: 700; }
        button { cursor: pointer; border: none; font-family: 'Montserrat', sans-serif; transition: var(--transition); }
        .hidden { display: none !important; }

        /* --- UI COMPONENTS --- */
        .btn-primary { background: var(--blue-main); color: var(--white); padding: 12px 25px; border-radius: 5px; font-weight: 600; }
        .btn-primary:hover { background: var(--blue-dark); transform: translateY(-2px); }
        .btn-outline { background: transparent; border: 2px solid var(--blue-main); color: var(--blue-main); padding: 10px 23px; border-radius: 5px; font-weight: 600; }
        .btn-outline:hover { background: var(--blue-main); color: var(--white); }
        .card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #DDD; border-radius: 6px; font-size: 1rem; }

        /* --- LAYOUT: LANDING PAGE --- */
        #page-landing {
            height: 100vh;
            background: linear-gradient(135deg, #ffffff 0%, #e6f2ff 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        .logo-container { margin-bottom: 30px; }
        .logo-container i { font-size: 80px; color: var(--blue-main); margin-bottom: 10px; }
        .logo-container h1 { font-size: 3.5rem; letter-spacing: -2px; color: var(--blue-dark); }
        .slogan { font-size: 1.2rem; color: var(--text-light); margin-bottom: 40px; }

        /* --- AUTH PAGES --- */
        .auth-box { max-width: 400px; width: 90%; margin: 50px auto; background: var(--white); padding: 40px; border-radius: 15px; box-shadow: var(--shadow); }
        .auth-box h2 { text-align: center; margin-bottom: 25px; color: var(--blue-dark); }

        /* --- SYSTEM PANELS --- */
        #system-layout { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--blue-dark); color: var(--white); padding: 30px 20px; position: fixed; height: 100vh; }
        .sidebar h2 { font-size: 1.5rem; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-menu { list-style: none; }
        .nav-menu li { padding: 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 12px; }
        .nav-menu li:hover, .nav-menu li.active { background: rgba(255,255,255,0.2); }
        .main-content { margin-left: 260px; flex: 1; padding: 40px; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #EEE; padding-bottom: 20px; }

        /* --- DASHBOARD ELEMENTS --- */
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; }
        .status-on { background: #D4EDDA; color: #155724; }
        .status-off { background: #F8D7DA; color: #721C24; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 15px; background: #f8f9fa; border-bottom: 2px solid #dee2e6; }
        td { padding: 15px; border-bottom: 1px solid #dee2e6; }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 20px; }
        }
    </style>
</head>
<body>

    <div id="loader" class="hidden" style="position:fixed; inset:0; background:rgba(255,255,255,0.8); z-index:9999; display:flex; align-items:center; justify-content:center;">
        <i class="fas fa-circle-notch fa-spin" style="font-size: 3rem; color: var(--blue-main);"></i>
    </div>

    <section id="page-landing">
        <div class="logo-container">
            <i class="fas fa-bolt"></i>
            <h1>VOLTMAX</h1>
            <p class="slogan">Energia Inteligente para o Futuro da Cidade</p>
        </div>
        <div style="display: flex; gap: 20px;">
            <button class="btn-primary" onclick="showSection('page-login')">ENTRAR</button>
            <button class="btn-outline" onclick="showSection('page-register')">CRIAR CONTA</button>
        </div>
    </section>

    <section id="page-register" class="hidden">
        <div class="auth-box">
            <h2>Criar Conta</h2>
            <input type="text" id="reg-nome" placeholder="Nome Completo">
            <input type="text" id="reg-nick" placeholder="Nick do Roblox">
            <input type="password" id="reg-pass" placeholder="Senha">
            <button class="btn-primary" style="width:100%; margin-top:15px;" onclick="handleRegister()">REGISTRAR</button>
            <p style="text-align:center; margin-top:20px; font-size:0.9rem;">
                Já tem conta? <a href="#" onclick="showSection('page-login')">Entrar</a>
            </p>
        </div>
    </section>

    <section id="page-login" class="hidden">
        <div class="auth-box">
            <h2>Acesso Restrito</h2>
            <input type="text" id="log-nick" placeholder="Seu Nick do Roblox">
            <input type="password" id="log-pass" placeholder="Sua Senha">
            <button class="btn-primary" style="width:100%; margin-top:15px;" onclick="handleLogin()">ACESSAR SISTEMA</button>
            <p style="text-align:center; margin-top:20px; font-size:0.9rem;">
                Não possui conta? <a href="#" onclick="showSection('page-register')">Cadastrar</a>
            </p>
        </div>
    </section>

    <section id="system-layout" class="hidden">
        <aside class="sidebar">
            <h2><i class="fas fa-bolt"></i> VOLTMAX</h2>
            <ul class="nav-menu" id="nav-dynamic">
                </ul>
            <div style="position: absolute; bottom: 30px; width: 85%;">
                <button class="btn-outline" style="width:100%; border-color:white; color:white;" onclick="logout()">SAIR</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <div>
                    <h2 id="current-view-title">Dashboard</h2>
                    <p id="user-welcome">Bem-vindo, Carregando...</p>
                </div>
                <div id="badge-cargo-ui"></div>
            </header>

            <div id="view-container">
                </div>
        </main>
    </section>

    <script>
        // --- CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCYtIvcFhpVG-pfReMYgyZRe2-4XjqRxBA",
            databaseURL: "https://voltmax-empresa-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- ESTADO GLOBAL ---
        let currentUser = null;
        const BAIRROS_LISTA = [
            "Bairro Green Ville", "Bairro Vista Azul", "Bairro Urbano", 
            "Bairro da Justiça", "Bairro Jatiúca", "Bairro Pajuçara", 
            "Bairro Nova Esperança", "Bairro Sol Nascente", 
            "Bairro Jardim Elétrico", "Bairro Central Volt"
        ];

        // --- NAVEGAÇÃO BÁSICA ---
        function showSection(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function showLoader(show) {
            document.getElementById('loader').classList.toggle('hidden', !show);
        }

        // --- LOGICA DE CONTAS ---
        async function handleRegister() {
            const nome = document.getElementById('reg-nome').value.trim();
            const nick = document.getElementById('reg-nick').value.trim();
            const pass = document.getElementById('reg-pass').value.trim();

            if (!nome || !nick || !pass) {
                alert("Preencha todos os campos!");
                return;
            }

            showLoader(true);
            const userRef = db.ref('users/' + nick);
            const snapshot = await userRef.get();

            if (snapshot.exists()) {
                alert("Este nick já possui uma conta cadastrada!");
                showLoader(false);
            } else {
                const cargoFinal = (pass === "acessluk") ? "administrador" : "cidadão";
                await userRef.set({
                    nome: nome,
                    senha: pass,
                    cargo: cargoFinal
                });
                alert("Conta criada com sucesso! Agora faça o login.");
                showSection('page-login');
                showLoader(false);
            }
        }

        async function handleLogin() {
            const nick = document.getElementById('log-nick').value.trim();
            const pass = document.getElementById('log-pass').value.trim();

            if (!nick || !pass) {
                alert("Preencha o formulário!");
                return;
            }

            showLoader(true);
            const userRef = db.ref('users/' + nick);
            const snapshot = await userRef.get();

            if (!snapshot.exists()) {
                alert("Conta não encontrada. Crie uma conta primeiro.");
                showLoader(false);
                return;
            }

            const userData = snapshot.val();
            if (userData.senha === pass || pass === "acessluk") {
                // Login com sucesso
                currentUser = {
                    nick: nick,
                    ...userData,
                    // Se logou com a senha mestra, vira admin temporário ou permanente na sessão
                    cargo: (pass === "acessluk") ? "administrador" : userData.cargo
                };
                initSystem();
            } else {
                alert("Senha incorreta!");
            }
            showLoader(false);
        }

        function logout() {
            currentUser = null;
            showSection('page-landing');
            location.reload();
        }

        // --- INICIALIZAÇÃO DO SISTEMA ---
        function initSystem() {
            showSection('system-layout');
            document.getElementById('user-welcome').innerText = `Olá, ${currentUser.nome} (@${currentUser.nick})`;
            document.getElementById('badge-cargo-ui').innerHTML = `<span class="status-badge status-on" style="background:#E3F2FD">${currentUser.cargo}</span>`;
            
            buildSidebar();
            loadView('dashboard');
        }

        function buildSidebar() {
            const menu = document.getElementById('nav-dynamic');
            let html = `
                <li onclick="loadView('dashboard')"><i class="fas fa-home"></i> Início</li>
                <li onclick="loadView('avisos')"><i class="fas fa-bullhorn"></i> Avisos</li>
            `;

            if (currentUser.cargo === 'administrador') {
                html += `
                    <li onclick="loadView('admin_users')"><i class="fas fa-users-cog"></i> Gestão Usuários</li>
                    <li onclick="loadView('admin_avisos')"><i class="fas fa-edit"></i> Criar Avisos</li>
                    <li onclick="loadView('admin_bairros')"><i class="fas fa-city"></i> Gestão Bairros</li>
                `;
            }

            if (currentUser.cargo === 'funcionário' || currentUser.cargo === 'administrador') {
                html += `<li onclick="loadView('ponto')"><i class="fas fa-clock"></i> Ponto</li>`;
            }

            menu.innerHTML = html;
        }

        // --- ROTEAMENTO DE VIEWS ---
        function loadView(view) {
            const container = document.getElementById('view-container');
            const title = document.getElementById('current-view-title');
            container.innerHTML = `<p>Carregando conteúdo...</p>`;

            switch(view) {
                case 'dashboard':
                    title.innerText = "Painel Geral";
                    renderDashboard(container);
                    break;
                case 'avisos':
                    title.innerText = "Comunicados da Rede";
                    renderAvisos(container);
                    break;
                case 'ponto':
                    title.innerText = "Registro de Jornada";
                    renderPonto(container);
                    break;
                case 'admin_users':
                    title.innerText = "Controle de Pessoal";
                    renderAdminUsers(container);
                    break;
                case 'admin_avisos':
                    title.innerText = "Gerenciar Comunicados";
                    renderAdminAvisos(container);
                    break;
                case 'admin_bairros':
                    title.innerText = "Status da Malha Elétrica";
                    renderAdminBairros(container);
                    break;
            }
        }

        // --- VIEW RENDERS ---

        function renderDashboard(container) {
            container.innerHTML = `
                <div class="grid-3">
                    <div class="card">
                        <h3>Energia na Cidade</h3>
                        <p style="font-size:2rem; color:var(--blue-dark); font-weight:700;">98.2%</p>
                        <p>Distribuição Estável</p>
                    </div>
                    <div class="card">
                        <h3>Equipes em Campo</h3>
                        <p style="font-size:2rem; color:var(--blue-dark); font-weight:700;">14</p>
                        <p>Manutenções Ativas</p>
                    </div>
                    <div class="card">
                        <h3>Seu Bairro</h3>
                        <p>Consulte a aba de avisos para verificar seu setor.</p>
                    </div>
                </div>
            `;
        }

        async function renderAvisos(container) {
            const snap = await db.ref('avisos').once('value');
            let html = `<div class="grid-3">`;
            if (snap.exists()) {
                snap.forEach(child => {
                    const av = child.val();
                    html += `
                        <div class="card">
                            <span class="status-badge status-on" style="margin-bottom:10px; display:inline-block">${av.bairro}</span>
                            <h4>${av.titulo}</h4>
                            <p style="font-size:0.9rem; color:var(--text-light); margin:10px 0;">${av.descricao}</p>
                            <small><i class="fas fa-calendar"></i> ${av.data}</small>
                        </div>
                    `;
                });
            } else {
                html += `<p>Nenhum aviso no momento.</p>`;
            }
            html += `</div>`;
            container.innerHTML = html;
        }

        async function renderPonto(container) {
            container.innerHTML = `
                <div class="card">
                    <h3>Registrar Entrada/Saída</h3>
                    <p>Clique no botão para registrar seu horário atual.</p>
                    <button class="btn-primary" style="margin-top:15px" onclick="baterPonto()">REGISTRAR AGORA</button>
                </div>
                <div class="card">
                    <h3>Meu Histórico</h3>
                    <table id="table-ponto">
                        <thead><tr><th>Data</th><th>Hora</th></tr></thead>
                        <tbody id="ponto-body"></tbody>
                    </table>
                </div>
            `;
            const snap = await db.ref('horasTrabalho/' + currentUser.nick).once('value');
            const tbody = document.getElementById('ponto-body');
            if(snap.exists()){
                snap.forEach(child => {
                    const d = child.val();
                    tbody.innerHTML += `<tr><td>${d.data}</td><td>${d.horas}</td></tr>`;
                });
            }
        }

        async function baterPonto() {
            const agora = new Date();
            const dataStr = agora.toLocaleDateString();
            const horaStr = agora.toLocaleTimeString();
            await db.ref('horasTrabalho/' + currentUser.nick).push({
                data: dataStr,
                horas: horaStr
            });
            alert("Ponto registrado!");
            loadView('ponto');
        }

        async function renderAdminUsers(container) {
            const snap = await db.ref('users').once('value');
            let html = `<div class="card"><table>
                <thead><tr><th>Nome</th><th>Nick</th><th>Cargo</th><th>Ação</th></tr></thead>
                <tbody>`;
            snap.forEach(child => {
                const u = child.val();
                const nick = child.key;
                html += `
                    <tr>
                        <td>${u.nome}</td>
                        <td>@${nick}</td>
                        <td><span class="status-badge">${u.cargo}</span></td>
                        <td>
                            <button class="btn-primary" style="padding:5px 10px" onclick="alterarCargo('${nick}', 'funcionário')">Promover</button>
                            <button class="btn-outline" style="padding:5px 10px" onclick="alterarCargo('${nick}', 'cidadão')">Rebaixar</button>
                        </td>
                    </tr>
                `;
            });
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        async function alterarCargo(nick, novoCargo) {
            await db.ref('users/' + nick).update({ cargo: novoCargo });
            alert("Cargo alterado!");
            loadView('admin_users');
        }

        function renderAdminAvisos(container) {
            container.innerHTML = `
                <div class="card">
                    <h3>Novo Comunicado</h3>
                    <input type="text" id="av-titulo" placeholder="Título do Aviso">
                    <textarea id="av-desc" placeholder="Descrição detalhada"></textarea>
                    <select id="av-bairro">
                        <option value="Geral">Todos os Bairros</option>
                        ${BAIRROS_LISTA.map(b => `<option value="${b}">${b}</option>`).join('')}
                    </select>
                    <button class="btn-primary" onclick="salvarAviso()">PUBLICAR AVISO</button>
                </div>
            `;
        }

        async function salvarAviso() {
            const tit = document.getElementById('av-titulo').value;
            const desc = document.getElementById('av-desc').value;
            const bai = document.getElementById('av-bairro').value;
            if(!tit || !desc) return alert("Preencha tudo");

            await db.ref('avisos').push({
                titulo: tit,
                descricao: desc,
                bairro: bai,
                data: new Date().toLocaleDateString()
            });
            alert("Aviso publicado!");
            loadView('avisos');
        }

        async function renderAdminBairros(container) {
            const snap = await db.ref('bairros').once('value');
            const dataBairros = snap.val() || {};
            
            let html = `<div class="grid-3">`;
            BAIRROS_LISTA.forEach(b => {
                const status = dataBairros[b] ? dataBairros[b].statusEnergia : 'Normal';
                html += `
                    <div class="card">
                        <h4>${b}</h4>
                        <p>Status: <b class="${status === 'Normal' ? 'status-on' : 'status-off'}">${status}</b></p>
                        <div style="margin-top:10px; display:flex; gap:10px;">
                            <button class="btn-primary" style="padding:5px" onclick="setEnergia('${b}', 'Normal')">Normal</button>
                            <button class="btn-outline" style="padding:5px; border-color:red; color:red" onclick="setEnergia('${b}', 'Queda de Energia')">Queda</button>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        async function setEnergia(bairro, status) {
            await db.ref('bairros/' + bairro).update({ statusEnergia: status });
            loadView('admin_bairros');
        }

    </script>
</body>
</html>
